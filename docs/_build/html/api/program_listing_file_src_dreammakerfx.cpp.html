

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Program Listing for File dreammakerfx.cpp &mdash; DreamMaker FX Documentation  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
        <script type="text/javascript" src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/collapsible-lists/css/tree_view.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> DreamMaker FX Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../markdown/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/echo_basic.html">Building a Basic Echo Pedal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/adding_effects.html">The basics of creating / adding effects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/routing_audio.html">The basics of routing audio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/controlling_effects.html">The basics of controlling effects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/using_api.html">Using the API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/debugging.html">Debugging Sketches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../markdown/troubleshooting.html">General troubleshooting</a></li>
</ul>
<p class="caption"><span class="caption-text">Pedal Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="classfx__pedal.html">Pedal</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__led.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__pot.html">Pots/Knobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__switch.html">Switches</a></li>
</ul>
<p class="caption"><span class="caption-text">Effect Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="classfx__adsr__envelope.html">ADSR Envelope</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__amplitude__mod.html">Amplitude Modulator</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__compressor.html">Compressor</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__delay.html">Delay</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__destructor.html">Destructor</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__envelope__tracker.html">Envelope Follower</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__gain.html">Gain</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__instrument__synth.html">Instrument Synth</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__looper.html">Looper</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__multitap__delay.html">Multi-tap Delay</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__oscillator.html">Oscillator</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__phase__shifter.html">Phase Shifter</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__pitch__shift.html">Pitch Shifter</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__ring__mod.html">Ring Modulator</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__slicer.html">Slicer</a></li>
<li class="toctree-l1"><a class="reference internal" href="classfx__variable__delay.html">Variable Delay</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DreamMaker FX Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Program Listing for File dreammakerfx.cpp</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/api/program_listing_file_src_dreammakerfx.cpp.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="program-listing-for-file-dreammakerfx-cpp">
<span id="program-listing-file-src-dreammakerfx-cpp"></span><h1>Program Listing for File dreammakerfx.cpp<a class="headerlink" href="#program-listing-for-file-dreammakerfx-cpp" title="Permalink to this headline">¶</a></h1>
<p>↰ <a class="reference internal" href="file_src_dreammakerfx.cpp.html#file-src-dreammakerfx-cpp"><span class="std std-ref">Return to documentation for file</span></a> (<code class="docutils literal notranslate"><span class="pre">src/dreammakerfx.cpp</span></code>)</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Copyright (c) 2020 Run Jump Labs LLC.  All right reserved.</span>
<span class="c1">// This code is licensed under MIT license (see license.txt for details)</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;Arduino.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;dreammakerfx.h&quot;</span><span class="cp"></span>


<span class="n">fx_pedal</span> <span class="n">pedal</span><span class="p">;</span>

<span class="cm">/************************************************************************</span>
<span class="cm"> *  Initialization</span>
<span class="cm"> ***********************************************************************/</span>

<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">init</span><span class="p">(</span><span class="n">MSG_WARN</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">DEBUG_MSG_LEVEL</span> <span class="n">debug_level</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">init</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>


<span class="p">[[</span><span class="n">deprecated</span><span class="p">(</span><span class="s">&quot;Replaced by init(DEBUG_MSG_LEVEL debug_level), which has an improved interface&quot;</span><span class="p">)]]</span>
<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="kt">bool</span> <span class="n">debug_enable</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">debug_enable</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">init</span><span class="p">(</span><span class="n">MSG_INFO</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">init</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">[[</span><span class="n">deprecated</span><span class="p">(</span><span class="s">&quot;Replaced by init(DEBUG_MSG_LEVEL debug_level), which has an improved interface&quot;</span><span class="p">)]]</span>
<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="kt">bool</span> <span class="n">debug_enable</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">dsp_telem</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dsp_telem</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">init</span><span class="p">(</span><span class="n">MSG_DEBUG</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">DEBUG_MSG_LEVEL</span> <span class="n">debug_level</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">dsp_no_reset</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">dmfx_debug_level</span> <span class="o">=</span> <span class="n">debug_level</span><span class="p">;</span>
  <span class="n">dmfx_debug_no_reset</span> <span class="o">=</span> <span class="n">debug_no_reset</span> <span class="o">=</span> <span class="n">dsp_no_reset</span><span class="p">;</span>

  <span class="cp">#if defined (DM_FX)</span>
    <span class="c1">// Setup LEDs</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">PIN_FOOTSW_LED_1</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">PIN_FOOTSW_LED_2</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">PIN_ARD_LED</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">PIN_USR_PB</span><span class="p">,</span> <span class="n">INPUT</span><span class="p">);</span>
    <span class="n">attachInterrupt</span><span class="p">(</span><span class="n">digitalPinToInterrupt</span><span class="p">(</span><span class="n">PIN_USR_PB</span><span class="p">),</span> <span class="n">user_pb_pressed</span><span class="p">,</span> <span class="n">FALLING</span><span class="p">);</span>

  <span class="cp">#elif defined (DM_FX_TWO)</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">PIN_ARD_LED_G</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">PIN_ARD_LED_Y</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">PIN_ARD_LED_G</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">PIN_ARD_LED_Y</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
  <span class="cp">#endif</span>

  <span class="c1">// Initialize hardware pins</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">PIN_FOOTSW_1</span><span class="p">,</span> <span class="n">INPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">PIN_FOOTSW_2</span><span class="p">,</span> <span class="n">INPUT</span><span class="p">);</span>

  <span class="kt">bool</span> <span class="n">left</span> <span class="o">=</span> <span class="n">digitalRead</span><span class="p">(</span><span class="n">PIN_FOOTSW_LEFT</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="n">right</span> <span class="o">=</span> <span class="n">digitalRead</span><span class="p">(</span><span class="n">PIN_FOOTSW_RIGHT</span><span class="p">);</span>

  <span class="c1">// if both buttons held, reboot into bootloader</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">turn_on_left_footsw_led</span><span class="p">();</span>
      <span class="n">turn_off_right_footsw_led</span><span class="p">();;</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
      <span class="n">turn_off_left_footsw_led</span><span class="p">();;</span>
      <span class="n">turn_on_right_footsw_led</span><span class="p">();;</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">reset_into_bootloader</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// Initialize the RGB LEDs if present</span>
  <span class="n">rgb_leds_init</span><span class="p">();</span>
  <span class="n">turn_on_left_footsw_led_rgb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
  <span class="n">turn_on_center_footsw_led_rgb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
  <span class="n">turn_on_right_footsw_led_rgb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>

  <span class="kt">int</span> <span class="n">now</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
  <span class="kt">bool</span> <span class="n">timeout</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span> <span class="o">!</span><span class="n">Serial</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">2000</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">timeout</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cp">#if defined (DM_FX)</span>
    <span class="c1">// Initialize the WM8731</span>
    <span class="n">wm8731_initialize</span><span class="p">();</span>
  <span class="cp">#elif defined (DM_FX_TWO)</span>
    <span class="c1">// Initialize SigmaDSP</span>
    <span class="n">adau1761_initialize</span><span class="p">();</span>
  <span class="cp">#endif</span>

  <span class="n">turn_on_left_footsw_led_rgb</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
  <span class="n">turn_on_center_footsw_led_rgb</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
  <span class="n">turn_on_right_footsw_led_rgb</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

  <span class="c1">// Set up telemetry link to SHARC</span>
  <span class="n">Serial1</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
  <span class="c1">// Set up Serial USB link</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>

  <span class="n">attachInterrupt</span><span class="p">(</span><span class="n">digitalPinToInterrupt</span><span class="p">(</span><span class="n">PIN_FOOTSW_1</span><span class="p">),</span> <span class="n">footswitch_right_pressed_isr</span><span class="p">,</span> <span class="n">FALLING</span><span class="p">);</span>
  <span class="n">attachInterrupt</span><span class="p">(</span><span class="n">digitalPinToInterrupt</span><span class="p">(</span><span class="n">PIN_FOOTSW_2</span><span class="p">),</span> <span class="n">footswitch_left_pressed_isr</span><span class="p">,</span> <span class="n">FALLING</span><span class="p">);</span>


  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug_no_reset</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Reset the DSP</span>
    <span class="n">dsp_reset</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// If we&#39;re not resetting DSP, at least make sure it&#39;s not still using the SPI port to boot</span>
    <span class="n">wait_for_dsp_spi_flash_access_to_cease</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">turn_on_left_footsw_led_rgb</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">turn_on_center_footsw_led_rgb</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">turn_on_right_footsw_led_rgb</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>


  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;DreamMaker FX By Run Jump Labs&quot;</span><span class="p">);</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot; (version: &quot;</span><span class="p">);</span>
  <span class="n">String</span> <span class="n">package_str</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">API_VERSION</span><span class="p">);</span>
  <span class="n">package_str</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">,</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">package_str</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">);</span>

  <span class="c1">// Wait for the DSP to boot and report firmware</span>
  <span class="n">wait_for_dsp_to_boot</span><span class="p">();</span>

  <span class="n">turn_on_left_footsw_led_rgb</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
  <span class="n">turn_on_center_footsw_led_rgb</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
  <span class="n">turn_on_right_footsw_led_rgb</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

  <span class="kt">bool</span> <span class="n">firmware_match</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dsp_status</span><span class="p">.</span><span class="n">firmware_ver</span> <span class="o">!=</span> <span class="n">API_VERSION</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">firmware_match</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">firmware_match</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot; The Arduino package version does not match the DSP firmware version, updating firmware...&quot;</span><span class="p">);</span>
    <span class="n">dsp_update_firmware_image</span><span class="p">();</span>
    <span class="n">dsp_reset</span><span class="p">();</span>
    <span class="n">wait_for_dsp_spi_flash_access_to_cease</span><span class="p">();</span>
    <span class="n">wait_for_dsp_to_boot</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// Wait for the DSP to be ready</span>
  <span class="n">wait_for_dsp_to_be_ready</span><span class="p">();</span>

  <span class="n">turn_off_left_footsw_led</span><span class="p">();</span>
  <span class="n">turn_off_center_footsw_led</span><span class="p">();</span>
  <span class="n">turn_off_right_footsw_led</span><span class="p">();</span>

  <span class="n">initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="p">}</span>




<span class="cm">/******************************************************************************</span>
<span class="cm"> *  DSP SPI Protocol</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#ifndef DOXYGEN_SHOULD_SKIP_THIS</span>

<span class="kt">void</span>  <span class="n">fx_pedal</span><span class="o">::</span><span class="n">spi_transmit_control_routing_stack</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Starting&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>

  <span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">routing_block</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">total_control_routes</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">routing_block</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Could not allocate space for routing block&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
      <span class="n">display_error_status</span><span class="p">(</span><span class="n">ERROR_INTERNAL</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// serialize routing data</span>
  <span class="kt">int</span> <span class="n">indx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">routing_block</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">HEADER_CONTROL_ROUTING_BLOCK</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">total_control_routes</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">routing_block</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">control_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_node_indx</span><span class="p">;</span>
    <span class="n">routing_block</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">control_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_node_indx</span><span class="p">;</span>
    <span class="n">routing_block</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_param_id</span><span class="p">;</span>
    <span class="n">routing_block</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_param_id</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scale</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">part_32</span> <span class="o">=</span> <span class="o">*</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">scale</span><span class="p">;</span>
    <span class="n">routing_block</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="n">part_32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
    <span class="n">routing_block</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="n">part_32</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
    <span class="n">part_32</span> <span class="o">=</span> <span class="o">*</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">;</span>
    <span class="n">routing_block</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="n">part_32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
    <span class="n">routing_block</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="n">part_32</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
    <span class="n">routing_block</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">;</span>

  <span class="p">}</span>

  <span class="c1">// Copy to SPI transmit fifo</span>
  <span class="n">spi_fifo_insert_block</span><span class="p">(</span><span class="n">routing_block</span><span class="p">,</span> <span class="n">indx</span><span class="p">);</span>

  <span class="n">free</span> <span class="p">(</span><span class="n">routing_block</span><span class="p">);</span>

  <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Complete&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span>  <span class="n">fx_pedal</span><span class="o">::</span><span class="n">spi_transmit_audio_routing_stack</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Starting&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>

  <span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">routing_block</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">total_audio_routes</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">routing_block</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Could not allocate space for routing block&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
      <span class="n">display_error_status</span><span class="p">(</span><span class="n">ERROR_INTERNAL</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// serialize routing data</span>
  <span class="kt">int</span> <span class="n">indx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">routing_block</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">HEADER_AUDIO_ROUTING_BLOCK</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">total_audio_routes</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">routing_block</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_node_indx</span><span class="p">;</span>
    <span class="n">routing_block</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_node_indx</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Copy to SPI transmit fifo</span>
  <span class="n">spi_fifo_insert_block</span><span class="p">(</span><span class="n">routing_block</span><span class="p">,</span> <span class="n">indx</span><span class="p">);</span>

  <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Complete&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>


<span class="p">}</span>


<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">spi_transmit_instance_stack</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Starting&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>

  <span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">spi_instance_block</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">((</span><span class="n">total_instances</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">spi_instance_block</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Could not allocate space for routing block&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
      <span class="n">display_error_status</span><span class="p">(</span><span class="n">ERROR_INTERNAL</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// serialize instance data</span>
  <span class="kt">int</span> <span class="n">indx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">spi_instance_block</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">HEADER_INSTANCE_BLOCK</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">total_instances</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">spi_instance_block</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Copy to SPI transmit fifo</span>
  <span class="n">spi_fifo_insert_block</span><span class="p">(</span><span class="n">spi_instance_block</span><span class="p">,</span> <span class="n">indx</span><span class="p">);</span>

  <span class="n">free</span><span class="p">(</span><span class="n">spi_instance_block</span><span class="p">);</span>

  <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Complete&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">spi_transmit_param</span><span class="p">(</span><span class="n">EFFECT_TYPE</span> <span class="n">instance_type</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">instance_id</span><span class="p">,</span> <span class="n">PARAM_TYPES</span> <span class="n">param_type</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">param_id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Starting&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>

  <span class="k">static</span> <span class="kt">uint16_t</span> <span class="n">param_block</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">HEADER_SINGLE_PARAMETER</span><span class="p">};</span>

  <span class="kt">uint16_t</span> <span class="n">part_16</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">part_32</span><span class="p">;</span>

  <span class="n">param_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="n">instance_type</span><span class="p">;</span>
  <span class="n">param_block</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="n">instance_id</span><span class="p">;</span>
  <span class="n">param_block</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="n">param_type</span><span class="p">;</span>
  <span class="n">param_block</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_id</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">param_type</span> <span class="o">==</span> <span class="n">T_BOOL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">part_16</span> <span class="o">=</span> <span class="o">*</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">param_block</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">part_16</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">param_type</span> <span class="o">==</span> <span class="n">T_INT16</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">param_block</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">param_type</span> <span class="o">==</span> <span class="n">T_INT32</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">param_block</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)((</span><span class="o">*</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
    <span class="n">param_block</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)((</span><span class="o">*</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">param_type</span> <span class="o">==</span> <span class="n">T_FLOAT</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">part_32</span> <span class="o">=</span> <span class="o">*</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">param_block</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="n">part_32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
    <span class="n">param_block</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="n">part_32</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Add to transmit FIFO</span>
  <span class="n">spi_fifo_insert_block</span><span class="p">(</span><span class="n">param_block</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">param_block</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>

  <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Complete&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">spi_transmit_bypass</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">bypass_state</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Starting&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>
  <span class="kt">uint16_t</span> <span class="n">param_block</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

  <span class="n">param_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">HEADER_SET_BYPASS</span><span class="p">;</span>
  <span class="n">param_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bypass_state</span><span class="p">;</span>

  <span class="c1">// Copy to SPI transmit fifo</span>
  <span class="n">spi_fifo_insert_block</span><span class="p">(</span><span class="n">param_block</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

  <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Complete&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">spi_get_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

  <span class="kt">uint16_t</span> <span class="n">param_block</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">param_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">HEADER_GET_STATUS</span><span class="p">;</span>

  <span class="n">spi_fifo_insert_block</span><span class="p">(</span><span class="n">param_block</span><span class="p">,</span> <span class="n">SPI_DSP_STAT_FRAME_SIZE</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">spi_transmit_params</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">node_index</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Starting&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>

  <span class="kt">uint16_t</span> <span class="n">param_block</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
  <span class="kt">uint16_t</span> <span class="n">size</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_index</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;This instance is not part of a canvas&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
    <span class="n">display_error_status</span><span class="p">(</span><span class="n">ERROR_CODE_ILLEGAL_ROUTING</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">fx_effect</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_effect</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">node_index</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">effect</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;NULL effect encountered&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
    <span class="n">display_error_status</span><span class="p">(</span><span class="n">ERROR_CODE_ILLEGAL_ROUTING</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cp">#if 0</span><span class="c"></span>
<span class="c">    Serial.println(&quot;Generating parameter transmit block&quot;);</span>
<span class="cp">  #endif</span>

  <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">param_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">HEADER_PARAMETER_BLOCK</span><span class="p">;</span>
  <span class="n">param_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">node_index</span><span class="p">].</span><span class="n">type</span><span class="p">;</span>  <span class="c1">// instance type</span>
  <span class="n">param_block</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">node_index</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>    <span class="c1">// instance id</span>
  <span class="n">effect</span><span class="o">-&gt;</span><span class="n">serialize_params</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param_block</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
  <span class="n">size</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

  <span class="c1">// Copy to SPI transmit fifo</span>
  <span class="n">spi_fifo_insert_block</span><span class="p">(</span><span class="n">param_block</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

  <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Complete&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">spi_transmit_all_params</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Starting&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>

  <span class="kt">uint16_t</span> <span class="n">param_block</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
  <span class="kt">uint16_t</span> <span class="n">size</span><span class="p">;</span>

  <span class="n">param_block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">HEADER_PARAMETER_BLOCK</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">total_instances</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">fx_effect</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_effect</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">effect</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;NULL effect encountered&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
      <span class="n">display_error_status</span><span class="p">(</span><span class="n">ERROR_CODE_ILLEGAL_ROUTING</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">param_block</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">;</span>  <span class="c1">// instance type</span>
      <span class="n">param_block</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>    <span class="c1">// instance id</span>
      <span class="n">effect</span><span class="o">-&gt;</span><span class="n">serialize_params</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param_block</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
      <span class="n">size</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

      <span class="c1">// Copy to SPI transmit block</span>
      <span class="n">spi_fifo_insert_block</span><span class="p">(</span><span class="n">param_block</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Complete&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>
<span class="p">}</span>




<span class="kt">void</span>  <span class="n">fx_pedal</span><span class="o">::</span><span class="n">spi_service</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">spi_transmit_buffered_frames</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="c1">// DOXYGEN_SHOULD_SKIP_THIS</span>








<span class="cm">/******************************************************************************</span>
<span class="cm"> *  Audio and control routing</span>
<span class="cm"> *****************************************************************************/</span>


<span class="kt">bool</span>  <span class="n">fx_pedal</span><span class="o">::</span><span class="n">add_audio_route_to_stack</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">src_id</span><span class="p">,</span>
                                          <span class="kt">uint8_t</span> <span class="n">src_node_indx</span><span class="p">,</span>
                                          <span class="kt">uint8_t</span> <span class="n">dest_id</span><span class="p">,</span>
                                          <span class="kt">uint8_t</span> <span class="n">dest_node_indx</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">total_audio_routes</span><span class="p">].</span><span class="n">src_id</span> <span class="o">=</span> <span class="n">src_id</span><span class="p">;</span>
  <span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">total_audio_routes</span><span class="p">].</span><span class="n">src_node_indx</span> <span class="o">=</span> <span class="n">src_node_indx</span><span class="p">;</span>
  <span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">total_audio_routes</span><span class="p">].</span><span class="n">dest_id</span> <span class="o">=</span> <span class="n">dest_id</span><span class="p">;</span>
  <span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">total_audio_routes</span><span class="p">].</span><span class="n">dest_node_indx</span> <span class="o">=</span> <span class="n">dest_node_indx</span><span class="p">;</span>
  <span class="n">total_audio_routes</span><span class="o">++</span><span class="p">;</span>

  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>  <span class="n">fx_pedal</span><span class="o">::</span><span class="n">add_control_route_to_stack</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">src_id</span><span class="p">,</span>
                                            <span class="kt">uint8_t</span> <span class="n">src_node_indx</span><span class="p">,</span>
                                            <span class="kt">uint8_t</span> <span class="n">src_param_id</span><span class="p">,</span>
                                            <span class="kt">uint8_t</span> <span class="n">dest_id</span><span class="p">,</span>
                                            <span class="kt">uint8_t</span> <span class="n">dest_node_indx</span><span class="p">,</span>
                                            <span class="kt">uint8_t</span> <span class="n">dest_param_id</span><span class="p">,</span>
                                            <span class="kt">float</span> <span class="n">scale</span><span class="p">,</span>
                                            <span class="kt">float</span> <span class="n">offset</span><span class="p">,</span>
                                            <span class="n">CTRL_NODE_TYPE</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">total_control_routes</span><span class="p">].</span><span class="n">src_id</span> <span class="o">=</span> <span class="n">src_id</span><span class="p">;</span>
  <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">total_control_routes</span><span class="p">].</span><span class="n">src_node_indx</span> <span class="o">=</span> <span class="n">src_node_indx</span><span class="p">;</span>
  <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">total_control_routes</span><span class="p">].</span><span class="n">src_param_id</span> <span class="o">=</span> <span class="n">src_param_id</span><span class="p">;</span>
  <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">total_control_routes</span><span class="p">].</span><span class="n">dest_id</span> <span class="o">=</span> <span class="n">dest_id</span><span class="p">;</span>
  <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">total_control_routes</span><span class="p">].</span><span class="n">dest_node_indx</span> <span class="o">=</span> <span class="n">dest_node_indx</span><span class="p">;</span>
  <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">total_control_routes</span><span class="p">].</span><span class="n">dest_param_id</span> <span class="o">=</span> <span class="n">dest_param_id</span><span class="p">;</span>
  <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">total_control_routes</span><span class="p">].</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span><span class="p">;</span>
  <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">total_control_routes</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
  <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">total_control_routes</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

  <span class="n">total_control_routes</span><span class="o">++</span><span class="p">;</span>

  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">bool</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">route_audio</span><span class="p">(</span><span class="n">fx_audio_node</span> <span class="o">*</span> <span class="n">src</span><span class="p">,</span> <span class="n">fx_audio_node</span> <span class="o">*</span> <span class="n">dest</span><span class="p">)</span> <span class="p">{</span>

  <span class="kt">bool</span> <span class="n">local_debug</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="c1">// Ensure inputs and outputs are valid</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">node_direction</span> <span class="o">!=</span> <span class="n">NODE_OUT</span> <span class="o">||</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">node_direction</span> <span class="o">!=</span> <span class="n">NODE_IN</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Source node is not an output, or destination node is not an input&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">uint8_t</span> <span class="n">src_id</span><span class="p">,</span> <span class="n">dest_id</span><span class="p">;</span>

  <span class="c1">// Set to false in case we bail mid-way through due to error</span>
  <span class="n">valid_audio_routes</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

  <span class="c1">// Check to see if inputs and outputs are in our stack, and add if not</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_effect</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">total_instances</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_effect</span> <span class="o">==</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">src_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">instance_stack</span><span class="p">[</span><span class="n">total_instances</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_effect</span><span class="p">;</span>
      <span class="n">instance_stack</span><span class="p">[</span><span class="n">total_instances</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_effect</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">();</span>
      <span class="n">instance_stack</span><span class="p">[</span><span class="n">total_instances</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">total_instances</span><span class="p">;</span>
      <span class="n">src_id</span> <span class="o">=</span> <span class="n">total_instances</span><span class="p">;</span>

      <span class="cp">#if 0</span><span class="c"></span>
<span class="c">        Serial.print(&quot;route_audio(): Adding new (source) instance type: &quot;);</span>
<span class="c">        Serial.print(instance_stack[total_instances].type);</span>
<span class="c">        Serial.print(&quot;, address: &quot;);</span>
<span class="c">        Serial.println((uint32_t) instance_stack[total_instances].address, HEX);</span>
<span class="cp">      #endif</span>


      <span class="c1">// Set instance ID in this effect instance too</span>
      <span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_effect</span><span class="o">-&gt;</span><span class="n">instance_id</span> <span class="o">=</span> <span class="n">total_instances</span><span class="p">;</span>

      <span class="n">total_instances</span><span class="o">++</span><span class="p">;</span>

    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_canvas</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">src_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_effect</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">total_instances</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_effect</span> <span class="o">==</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">dest_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">instance_stack</span><span class="p">[</span><span class="n">total_instances</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_effect</span><span class="p">;</span>
      <span class="n">instance_stack</span><span class="p">[</span><span class="n">total_instances</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_effect</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">();</span>
      <span class="n">instance_stack</span><span class="p">[</span><span class="n">total_instances</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">total_instances</span><span class="p">;</span>
      <span class="n">dest_id</span> <span class="o">=</span> <span class="n">total_instances</span><span class="p">;</span>

      <span class="cp">#if 0</span><span class="c"></span>
<span class="c">        Serial.print(&quot;route_audio(): Adding new (dest) instance type: &quot;);</span>
<span class="c">        Serial.print(instance_stack[total_instances].type);</span>
<span class="c">        Serial.print(&quot;, address: &quot;);</span>
<span class="c">        Serial.println((uint32_t) instance_stack[total_instances].address, HEX);</span>
<span class="cp">      #endif</span>

      <span class="c1">// Set instance ID in this effect instance too</span>
      <span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_effect</span><span class="o">-&gt;</span><span class="n">instance_id</span> <span class="o">=</span> <span class="n">total_instances</span><span class="p">;</span>

      <span class="n">total_instances</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_canvas</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dest_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Add routes to our routing table</span>
  <span class="kt">uint8_t</span> <span class="n">src_node_indx</span><span class="p">,</span> <span class="n">dest_node_indx</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">res</span><span class="p">;</span>

  <span class="c1">// Look up source node</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_effect</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_effect</span><span class="o">-&gt;</span><span class="n">get_audio_node_index</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src_node_indx</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find this source node in the effect!&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_canvas</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_canvas</span><span class="o">-&gt;</span><span class="n">get_audio_node_index</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src_node_indx</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find this source node in the canvas!&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Look up destination node</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_effect</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_effect</span><span class="o">-&gt;</span><span class="n">get_audio_node_index</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dest_node_indx</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find this destination node in the effect!&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_canvas</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_canvas</span><span class="o">-&gt;</span><span class="n">get_audio_node_index</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dest_node_indx</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find this destination node in the canvas!&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Set both nodes to connected</span>
  <span class="n">src</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">dest</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

  <span class="c1">// Add route to routing table</span>
  <span class="n">add_audio_route_to_stack</span><span class="p">(</span><span class="n">src_id</span><span class="p">,</span> <span class="n">src_node_indx</span><span class="p">,</span> <span class="n">dest_id</span><span class="p">,</span> <span class="n">dest_node_indx</span><span class="p">);</span>

  <span class="c1">// Check routing table for any outputs that are being written to twice</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">total_audio_routes</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">total_audio_routes</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_id</span> <span class="o">==</span> <span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">dest_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_node_indx</span> <span class="o">==</span> <span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">dest_node_indx</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Two different effects writing to same audio node&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Happy days, we made it</span>
  <span class="n">valid_audio_routes</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">bool</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">route_control</span><span class="p">(</span><span class="n">fx_control_node</span> <span class="o">*</span> <span class="n">src</span><span class="p">,</span> <span class="n">fx_control_node</span> <span class="o">*</span> <span class="n">dest</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">route_control</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">route_control</span><span class="p">(</span><span class="n">fx_control_node</span> <span class="o">*</span> <span class="n">src</span><span class="p">,</span> <span class="n">fx_control_node</span> <span class="o">*</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">float</span> <span class="n">scale</span><span class="p">,</span> <span class="kt">float</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Set to false in case we bail mid-way through due to error</span>
  <span class="n">valid_control_routes</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="c1">// Ensure inputs and outputs are valid</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">node_direction</span> <span class="o">!=</span> <span class="n">NODE_OUT</span> <span class="o">||</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">node_direction</span> <span class="o">!=</span> <span class="n">NODE_IN</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Source must be output, dest must be input&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">uint8_t</span> <span class="n">src_id</span><span class="p">,</span> <span class="n">dest_id</span><span class="p">;</span>

  <span class="c1">// Check to see if inputs and outputs are in our stack, and add if not</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_effect</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">total_instances</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_effect</span> <span class="o">==</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">src_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">instance_stack</span><span class="p">[</span><span class="n">total_instances</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_effect</span><span class="p">;</span>
      <span class="n">instance_stack</span><span class="p">[</span><span class="n">total_instances</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_effect</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">();</span>
      <span class="n">instance_stack</span><span class="p">[</span><span class="n">total_instances</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">total_instances</span><span class="p">;</span>
      <span class="n">src_id</span> <span class="o">=</span> <span class="n">total_instances</span><span class="p">;</span>
      <span class="n">total_instances</span><span class="o">++</span><span class="p">;</span>

      <span class="cp">#if 0</span><span class="c"></span>
<span class="c">        Serial.println(src-&gt;parent_effect-&gt;get_name());</span>
<span class="cp">      #endif</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_canvas</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">src_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_effect</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">total_instances</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_effect</span> <span class="o">==</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">dest_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">instance_stack</span><span class="p">[</span><span class="n">total_instances</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_effect</span><span class="p">;</span>
      <span class="n">instance_stack</span><span class="p">[</span><span class="n">total_instances</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_effect</span><span class="o">-&gt;</span><span class="n">get_type</span><span class="p">();</span>
      <span class="n">instance_stack</span><span class="p">[</span><span class="n">total_instances</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">total_instances</span><span class="p">;</span>
      <span class="n">dest_id</span> <span class="o">=</span> <span class="n">total_instances</span><span class="p">;</span>
      <span class="n">total_instances</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_canvas</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dest_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Make sure controllers are compatible</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">node_type</span> <span class="o">!=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">node_type</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Trying to connect incompatible controls&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Add routes to our routing table</span>
  <span class="kt">uint8_t</span> <span class="n">src_node_indx</span><span class="p">,</span> <span class="n">dest_node_indx</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">res</span><span class="p">;</span>

  <span class="c1">// Look up source node</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_effect</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_effect</span><span class="o">-&gt;</span><span class="n">get_control_node_index</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src_node_indx</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find the source node in an effect&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_canvas</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_canvas</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">parent_canvas</span><span class="o">-&gt;</span><span class="n">get_control_node_index</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src_node_indx</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find the source node in the canvas&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Look up destination node</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_effect</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_effect</span><span class="o">-&gt;</span><span class="n">get_control_node_index</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dest_node_indx</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find the dest node in an effect&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_canvas</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_canvas</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">parent_canvas</span><span class="o">-&gt;</span><span class="n">get_control_node_index</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dest_node_indx</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find the dest node in the canvas&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Set both nodes to connected</span>
  <span class="n">src</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">dest</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

  <span class="c1">// Add route to routing table</span>
  <span class="n">add_control_route_to_stack</span><span class="p">(</span><span class="n">src_id</span><span class="p">,</span> <span class="n">src_node_indx</span><span class="p">,</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">param_id</span><span class="p">,</span> <span class="n">dest_id</span><span class="p">,</span> <span class="n">dest_node_indx</span><span class="p">,</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">param_id</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">dest</span><span class="o">-&gt;</span><span class="n">node_type</span><span class="p">);</span>

  <span class="c1">// Check routing table for any outputs that are being written to twice</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">total_control_routes</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">total_control_routes</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">control_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_id</span> <span class="o">==</span> <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">dest_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">control_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_node_indx</span> <span class="o">==</span> <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">dest_node_indx</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Two different effects writing to same control node&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Happy days, we made it</span>
  <span class="n">valid_control_routes</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="p">}</span>


<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">add_bypass_button</span><span class="p">(</span><span class="n">FOOTSWITCH</span> <span class="n">footswitch</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">bypass_control_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">pedal</span><span class="p">.</span><span class="n">bypassed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">bypass_footswitch</span> <span class="o">=</span> <span class="n">footswitch</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">add_tap_interval_button</span><span class="p">(</span><span class="n">FOOTSWITCH</span> <span class="n">footswitch</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">enable_led_flash</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tap_control_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bypass_footswitch</span> <span class="o">==</span> <span class="n">footswitch</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Attempting to add tap interval to footswitch already used for bypass&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">tap_led_flash</span> <span class="o">=</span> <span class="n">enable_led_flash</span><span class="p">;</span>
  <span class="n">tap_footswitch</span> <span class="o">=</span> <span class="n">footswitch</span><span class="p">;</span>
  <span class="n">tap_indx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">tap_last_tap</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>

<span class="p">}</span>


<span class="cp">#ifndef DOXYGEN_SHOULD_SKIP_THIS</span>

<span class="kt">bool</span>  <span class="n">fx_pedal</span><span class="o">::</span><span class="n">get_audio_node_index</span><span class="p">(</span><span class="n">fx_audio_node</span> <span class="o">*</span> <span class="n">node</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span> <span class="n">node_index</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_NODES_PER_FX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="n">audio_node_stack</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
      <span class="o">*</span><span class="n">node_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">bool</span>  <span class="n">fx_pedal</span><span class="o">::</span><span class="n">get_control_node_index</span><span class="p">(</span><span class="n">fx_control_node</span> <span class="o">*</span> <span class="n">node</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span> <span class="n">node_index</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_NODES_PER_FX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="n">control_node_stack</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
      <span class="o">*</span><span class="n">node_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif  </span><span class="c1">// DOXYGEN_SHOULD_SKIP_THIS</span>







<span class="cm">/******************************************************************************</span>
<span class="cm"> *  Canvas control functions</span>
<span class="cm"> *****************************************************************************/</span>


<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">service</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">tap_control_enabled</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tap_footswitch</span> <span class="o">==</span> <span class="n">FOOTSWITCH_LEFT</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">tap_led_flash_cntr</span> <span class="o">+</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">turn_on_left_footsw_led</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">turn_off_left_footsw_led</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tap_footswitch</span> <span class="o">==</span> <span class="n">FOOTSWITCH_RIGHT</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">tap_led_flash_cntr</span> <span class="o">+</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">turn_on_right_footsw_led</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">turn_off_right_footsw_led</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">((</span><span class="n">tap_blink_only_enabled</span> <span class="o">||</span> <span class="n">tap_control_enabled</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tap_locked</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">tap_led_flash_cntr</span> <span class="o">+</span> <span class="n">tap_interval_ms</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">tap_led_flash_cntr</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">tap_footswitch</span> <span class="o">==</span> <span class="n">FOOTSWITCH_LEFT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">turn_on_left_footsw_led</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tap_footswitch</span> <span class="o">==</span> <span class="n">FOOTSWITCH_RIGHT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">turn_on_right_footsw_led</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">tap_led_flash_cntr</span> <span class="o">+</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">tap_footswitch</span> <span class="o">==</span> <span class="n">FOOTSWITCH_LEFT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">turn_off_left_footsw_led</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tap_footswitch</span> <span class="o">==</span> <span class="n">FOOTSWITCH_RIGHT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">turn_off_right_footsw_led</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Service LEDs</span>
  <span class="n">led_left</span><span class="p">.</span><span class="n">service</span><span class="p">();</span>
  <span class="cp">#if defined (DM_FX_TWO)</span>
    <span class="n">led_center</span><span class="p">.</span><span class="n">service</span><span class="p">();</span>
  <span class="cp">#endif</span>
  <span class="n">led_right</span><span class="p">.</span><span class="n">service</span><span class="p">();</span>

  <span class="n">button_press_check</span><span class="p">();</span>
  <span class="n">service_button_events</span><span class="p">();</span>

  <span class="c1">// Read in telemetry data from the DSP</span>
  <span class="n">display_data_from_sharc</span><span class="p">();</span>

  <span class="c1">// Run the remainder of service loop ~30 times / second</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">last_service_ts</span> <span class="o">+</span> <span class="mi">33</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">last_service_ts</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>

  <span class="c1">// Read the pots and switches</span>
  <span class="cp">#if defined (DM_FX)</span>
    <span class="n">pot_right</span><span class="p">.</span><span class="n">read_pot</span><span class="p">();</span>
    <span class="n">pot_center</span><span class="p">.</span><span class="n">read_pot</span><span class="p">();</span>
    <span class="n">pot_left</span><span class="p">.</span><span class="n">read_pot</span><span class="p">();</span>

  <span class="cp">#elif defined (DM_FX_TWO)</span>
    <span class="n">pot_top_left</span><span class="p">.</span><span class="n">read_pot</span><span class="p">();</span>
    <span class="n">pot_top_right</span><span class="p">.</span><span class="n">read_pot</span><span class="p">();</span>
    <span class="n">pot_bot_left</span><span class="p">.</span><span class="n">read_pot</span><span class="p">();</span>
    <span class="n">pot_bot_center</span><span class="p">.</span><span class="n">read_pot</span><span class="p">();</span>
    <span class="n">pot_bot_right</span><span class="p">.</span><span class="n">read_pot</span><span class="p">();</span>
    <span class="n">exp_pedal</span><span class="p">.</span><span class="n">read_pot</span><span class="p">();</span>
    <span class="n">toggle_left</span><span class="p">.</span><span class="n">read_switch</span><span class="p">();</span>
    <span class="n">toggle_right</span><span class="p">.</span><span class="n">read_switch</span><span class="p">();</span>

  <span class="cp">#endif</span>

  <span class="c1">// Get status data from the DSP</span>
  <span class="n">spi_get_status</span><span class="p">();</span>

  <span class="c1">// Service any parameter updates</span>
  <span class="n">spi_service</span><span class="p">();</span>

<span class="p">}</span>

<span class="kt">void</span>    <span class="n">fx_pedal</span><span class="o">::</span><span class="n">bypass_fx</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Bypass&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>
  <span class="n">spi_transmit_bypass</span><span class="p">((</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span>    <span class="n">fx_pedal</span><span class="o">::</span><span class="n">enable_fx</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Enable&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>
  <span class="n">spi_transmit_bypass</span><span class="p">((</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">bool</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">run</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>


  <span class="kt">bool</span> <span class="n">ready</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

  <span class="c1">// Check to see if our routing is valid</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">total_audio_routes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;No routes defined&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
    <span class="n">display_error_status</span><span class="p">(</span><span class="n">ERROR_CODE_ILLEGAL_ROUTING</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid_audio_routes</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Errors in the audio routing.  Fix errors in your route_audio() calls.&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
    <span class="n">display_error_status</span><span class="p">(</span><span class="n">ERROR_CODE_ILLEGAL_ROUTING</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">total_control_routes</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">valid_control_routes</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Errors in the control routing.  Fix errors in your route_control() calls.&quot;</span><span class="p">,</span> <span class="n">MSG_ERROR</span><span class="p">);</span>
    <span class="n">display_error_status</span><span class="p">(</span><span class="n">ERROR_CODE_ILLEGAL_ROUTING</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">display_data_from_sharc</span><span class="p">();</span>

    <span class="c1">// Send routing stack to DSP</span>
    <span class="n">spi_transmit_audio_routing_stack</span><span class="p">();</span>
    <span class="n">display_data_from_sharc</span><span class="p">();</span>

    <span class="n">spi_transmit_control_routing_stack</span><span class="p">();</span>
    <span class="n">display_data_from_sharc</span><span class="p">();</span>

    <span class="c1">// Send instance stack to DSP</span>
    <span class="n">spi_transmit_instance_stack</span><span class="p">();</span>
    <span class="n">display_data_from_sharc</span><span class="p">();</span>

    <span class="c1">// Send parameters to DSP</span>
    <span class="n">spi_transmit_all_params</span><span class="p">();</span>
    <span class="n">display_data_from_sharc</span><span class="p">();</span>

    <span class="c1">// Wait for DSP to send message that canvas is running</span>
    <span class="n">wait_for_canvas_to_start</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">now</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">display_data_from_sharc</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// If we&#39;ve added bypass controls, start effect bypassed</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bypass_control_enabled</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">pedal</span><span class="p">.</span><span class="n">bypassed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">bypass_fx</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">pedal</span><span class="p">.</span><span class="n">bypassed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="n">enable_fx</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dsp_status</span><span class="p">.</span><span class="n">state_canvas_running</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Canvas is running&quot;</span><span class="p">,</span> <span class="n">MSG_INFO</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">report_canvas_errors</span><span class="p">();</span>
      <span class="n">ready</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Display error code on LEDs</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">display_error_status</span><span class="p">(</span><span class="n">ERROR_CODE_ILLEGAL_ROUTING</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">ready</span><span class="p">;</span>

<span class="p">}</span>




<span class="cm">/******************************************************************************</span>
<span class="cm"> *  Parameter control functions</span>
<span class="cm"> *****************************************************************************/</span>




<span class="cp">#ifndef DOXYGEN_SHOULD_SKIP_THIS</span>

<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">register_tap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

  <span class="kt">uint32_t</span> <span class="n">interval</span> <span class="o">=</span> <span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">tap_last_tap</span><span class="p">;</span>
  <span class="n">tap_last_tap</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
  <span class="n">tap_led_flash_cntr</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>

  <span class="cp">#if 0</span><span class="c"></span>
<span class="c">    Serial.print(&quot;Debug: interval:&quot;);</span>
<span class="c">    Serial.println(interval);</span>
<span class="cp">  #endif</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">tap_indx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">interval</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">tap_indx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">tap_locked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">tap_new_val</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">15</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">tap_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tap_indx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tap_history</span><span class="p">[</span><span class="n">tap_indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>
    <span class="n">tap_locked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">tap_history</span><span class="p">[</span><span class="n">tap_indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tap_indx</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">tap_indx</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">float</span> <span class="n">sum</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">tap_indx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">sum</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="n">tap_history</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">sum</span> <span class="o">*=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span> <span class="p">(</span><span class="n">tap_indx</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
    <span class="n">tap_locked</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">tap_interval_ms</span> <span class="o">=</span> <span class="n">sum</span><span class="p">;</span>
    <span class="n">tap_new_val</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="cp">#if 0</span><span class="c"></span>
<span class="c">      Serial.print(&quot;Debug: tap ms:&quot;);</span>
<span class="c">      Serial.println(tap_interval_ms);</span>
<span class="cp">    #endif</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">button_press_check</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">time_since_last_press</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">time_since_last_press</span> <span class="o">+</span> <span class="mi">75</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">time_since_last_press</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>

  <span class="kt">bool</span> <span class="n">left</span> <span class="o">=</span> <span class="o">!</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">PIN_FOOTSW_LEFT</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="n">right</span> <span class="o">=</span> <span class="o">!</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">PIN_FOOTSW_RIGHT</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&amp;&amp;</span> <span class="n">left</span> <span class="o">!=</span> <span class="n">footswitch_left_last_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">footswitch_left_pressed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span> <span class="o">&amp;&amp;</span> <span class="n">left</span> <span class="o">!=</span> <span class="n">footswitch_left_last_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">footswitch_left_released</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">right</span> <span class="o">&amp;&amp;</span> <span class="n">right</span> <span class="o">!=</span> <span class="n">footswitch_right_last_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">footswitch_right_pressed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">right</span> <span class="o">&amp;&amp;</span> <span class="n">right</span> <span class="o">!=</span> <span class="n">footswitch_right_last_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">footswitch_right_released</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">footswitch_left_last_state</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
  <span class="n">footswitch_right_last_state</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>  <span class="n">fx_pedal</span><span class="o">::</span><span class="n">service_button_events</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">footswitch_right_pressed_event</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">footswitch_right_pressed_event</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bypass_control_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">bypass_footswitch</span> <span class="o">==</span> <span class="n">FOOTSWITCH_RIGHT</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Toggle bypass&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">bypassed</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">led_right</span><span class="p">.</span><span class="n">turn_on</span><span class="p">();</span>
          <span class="n">enable_fx</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">led_right</span><span class="p">.</span><span class="n">turn_off</span><span class="p">();</span>
          <span class="n">bypass_fx</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">bypassed</span> <span class="o">=</span> <span class="o">!</span><span class="n">bypassed</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">footswitch_left_pressed_event</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">footswitch_left_pressed_event</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bypass_control_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">bypass_footswitch</span> <span class="o">==</span> <span class="n">FOOTSWITCH_LEFT</span><span class="p">)</span> <span class="p">{</span>

      <span class="n">DEBUG_MSG</span><span class="p">(</span><span class="s">&quot;Toggle bypass&quot;</span><span class="p">,</span> <span class="n">MSG_DEBUG</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">bypassed</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//Serial.println(&quot;Turning on left LED&quot;);</span>
        <span class="n">led_left</span><span class="p">.</span><span class="n">turn_on</span><span class="p">();</span>
        <span class="c1">//turn_on_left_footsw_led();</span>
        <span class="n">enable_fx</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">//Serial.println(&quot;Turning off left LED&quot;);</span>
        <span class="n">led_left</span><span class="p">.</span><span class="n">turn_off</span><span class="p">();</span>
        <span class="c1">//turn_off_left_footsw_led();</span>
        <span class="n">bypass_fx</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="n">bypassed</span> <span class="o">=</span> <span class="o">!</span><span class="n">bypassed</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="c1">// DOXYGEN_SHOULD_SKIP_THIS</span>



<span class="kt">bool</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">new_tap_interval</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">tap_new_val</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tap_new_val</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="kt">float</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">get_tap_interval_ms</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">tap_locked</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">tap_interval_ms</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mf">1000.0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">float</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">get_tap_freq_hz</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">tap_locked</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">0.001</span> <span class="o">*</span> <span class="n">tap_interval_ms</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mf">1.0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">set_tap_blink_rate_hz</span><span class="p">(</span><span class="kt">float</span> <span class="n">rate_hz</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rate_hz</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rate_hz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate_hz</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rate_hz</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">tap_interval_ms</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1000.0</span><span class="o">/</span><span class="n">rate_hz</span><span class="p">);</span>
  <span class="n">tap_locked</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">tap_control_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">set_tap_blink_rate_hz</span><span class="p">(</span><span class="kt">float</span> <span class="n">rate_hz</span><span class="p">,</span> <span class="n">FOOTSWITCH</span> <span class="n">led</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rate_hz</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rate_hz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate_hz</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rate_hz</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">tap_interval_ms</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1000.0</span><span class="o">/</span><span class="n">rate_hz</span><span class="p">);</span>
  <span class="n">tap_locked</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">tap_blink_only_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">tap_footswitch</span> <span class="o">=</span> <span class="n">led</span><span class="p">;</span>

<span class="p">}</span>


<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">set_tap_blink_rate_ms</span><span class="p">(</span><span class="kt">float</span> <span class="n">ms</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ms</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ms</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ms</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ms</span> <span class="o">=</span> <span class="mf">10000.0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">tap_interval_ms</span> <span class="o">=</span> <span class="n">ms</span><span class="p">;</span>
  <span class="n">tap_locked</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">tap_control_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">set_tap_blink_rate_ms</span><span class="p">(</span><span class="kt">float</span> <span class="n">ms</span><span class="p">,</span> <span class="n">FOOTSWITCH</span> <span class="n">led</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ms</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ms</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ms</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ms</span> <span class="o">=</span> <span class="mf">10000.0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">tap_interval_ms</span> <span class="o">=</span> <span class="n">ms</span><span class="p">;</span>
  <span class="n">tap_locked</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">tap_blink_only_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">tap_footswitch</span> <span class="o">=</span> <span class="n">led</span><span class="p">;</span>
<span class="p">}</span>



<span class="kt">bool</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">button_pressed</span><span class="p">(</span><span class="n">FOOTSWITCH</span> <span class="n">footswitch</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">enable_led</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">footswitch</span> <span class="o">==</span> <span class="n">FOOTSWITCH_BOTH</span> <span class="o">&amp;&amp;</span> <span class="n">footswitch_left_pressed</span> <span class="o">&amp;&amp;</span> <span class="n">footswitch_right_pressed</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">footswitch_left_pressed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">footswitch_left_released</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">footswitch_right_pressed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">footswitch_right_released</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">footswitch</span> <span class="o">==</span> <span class="n">FOOTSWITCH_LEFT</span> <span class="o">&amp;&amp;</span> <span class="n">footswitch_left_pressed</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">footswitch_left_pressed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">footswitch_left_released</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">enable_led</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">led_left</span><span class="p">.</span><span class="n">turn_on</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">footswitch</span> <span class="o">==</span> <span class="n">FOOTSWITCH_RIGHT</span> <span class="o">&amp;&amp;</span> <span class="n">footswitch_right_pressed</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">footswitch_right_pressed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">footswitch_right_released</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">enable_led</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">led_right</span><span class="p">.</span><span class="n">turn_on</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">button_released</span><span class="p">(</span><span class="n">FOOTSWITCH</span> <span class="n">footswitch</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">enable_led</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">footswitch</span> <span class="o">==</span> <span class="n">FOOTSWITCH_LEFT</span> <span class="o">&amp;&amp;</span> <span class="n">footswitch_left_released</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">footswitch_left_pressed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">footswitch_left_released</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">enable_led</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">led_left</span><span class="p">.</span><span class="n">turn_off</span><span class="p">();</span>
      <span class="c1">//turn_off_left_footsw_led();</span>
    <span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">footswitch</span> <span class="o">==</span> <span class="n">FOOTSWITCH_RIGHT</span> <span class="o">&amp;&amp;</span> <span class="n">footswitch_right_released</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">footswitch_right_pressed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">footswitch_right_released</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">enable_led</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">led_right</span><span class="p">.</span><span class="n">turn_off</span><span class="p">();</span>
      <span class="c1">//turn_off_right_footsw_led();</span>
    <span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>










<span class="kt">void</span> <span class="n">print_processor_load</span><span class="p">(</span><span class="kt">int</span> <span class="n">seconds</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">seconds</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">seconds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">now</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">now</span> <span class="o">+</span> <span class="n">seconds</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Processor load: &quot;</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">dsp_status</span><span class="p">.</span><span class="n">loading_percentage</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="p">);</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>





<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">print_instance_stack</span><span class="p">()</span> <span class="p">{</span>

  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Instance stack:&quot;</span><span class="p">);</span>

  <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="s">&quot; Total instances: %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">total_instances</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">total_instances</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">FX_UNDEFINED</span><span class="p">)</span> <span class="p">{</span>

      <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="s">&quot; ID: %#04x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;  Type: &quot;</span><span class="p">);</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">get_effect_type</span><span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot; (&quot;</span><span class="p">);</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">);</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">);</span>

      <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="s">&quot;  Address: %#04x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Undefined instance found&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">print_routing_table</span><span class="p">()</span> <span class="p">{</span>

  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Audio routing table:&quot;</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">total_audio_routes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">total_audio_routes</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_id</span> <span class="o">!=</span> <span class="n">UNDEFINED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot; Src ID: &quot;</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_id</span><span class="p">,</span> <span class="n">HEX</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;  Src Node Indx: &quot;</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_node_indx</span><span class="p">,</span> <span class="n">HEX</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot; Dest ID: &quot;</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_id</span><span class="p">,</span> <span class="n">HEX</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;  Dest Node Indx: &quot;</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_node_indx</span><span class="p">,</span> <span class="n">HEX</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot; No audio routes in canvas&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Control routing table:&quot;</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">total_control_routes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">total_control_routes</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">audio_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_id</span> <span class="o">!=</span> <span class="n">UNDEFINED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot; Src ID: &quot;</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_id</span><span class="p">,</span> <span class="n">HEX</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;  Src Node Indx: &quot;</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src_node_indx</span><span class="p">,</span> <span class="n">HEX</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot; Dest ID: &quot;</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_id</span><span class="p">,</span> <span class="n">HEX</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;  Dest Node Indx: &quot;</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">control_routing_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_node_indx</span><span class="p">,</span> <span class="n">HEX</span><span class="p">);</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot; No control routes in canvas&quot;</span><span class="p">);</span>
  <span class="p">}</span>


<span class="p">}</span>

<span class="kt">void</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">print_param_tables</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Parameter tables:&quot;</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">total_instances</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot; There are no effect instances in this canvas so there are no parameters&quot;</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">total_instances</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Null pointer encoundered for instance %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_ALLPASS_FILTER</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Allpass filter (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_allpass_filter</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_allpass_filter</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_ADSR_ENVELOPE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;ADSR Envelope (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_adsr_envelope</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_adsr_envelope</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>


      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_AMPLITUDE_MODULATOR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;AMP MODULATOR (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_amplitude_mod</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_amplitude_mod</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_BIQUAD_FILTER</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;BIQUAD (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_biquad_filter</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_biquad_filter</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_DESTRUCTOR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Destructor (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_destructor</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_destructor</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_COMPRESSOR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Compressor (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_compressor</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_compressor</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>


      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_DELAY</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;DELAY (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_delay</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_delay</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_DELAY_MULTITAP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;MULTITAP DELAY (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_multitap_delay</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_multitap_delay</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_ENVELOPE_TRACKER</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;ENVELOPE TRACKER (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_envelope_tracker</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_envelope_tracker</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>


      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_GAIN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;GAIN (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_gain</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_gain</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_MIXER_2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;MIXER x 2 (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_mixer_2</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_mixer_2</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_MIXER_3</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;MIXER x 3 (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_mixer_3</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_mixer_3</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_MIXER_4</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;MIXER x 4 (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_mixer_4</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_mixer_4</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_PHASE_SHIFTER</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;PHASE SHIFTER (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_phase_shifter</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_phase_shifter</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_PITCH_SHIFT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;PITCH SHIFT (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_pitch_shift</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_pitch_shift</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_RING_MOD</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;RING MODULATOR (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_ring_mod</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_ring_mod</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_SLICER</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;SLICER (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_slicer</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_slicer</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_LOOPER</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;LOOPER (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_looper</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_looper</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_INSTRUMENT_SYNTH</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;INSTRUMENT SYNTH (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_instrument_synth</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_instrument_synth</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_OSCILLATOR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;OSCILLATOR (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_oscillator</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_oscillator</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>


      <span class="k">if</span> <span class="p">(</span><span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">FX_VARIABLE_DELAY</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;VARIABLE DELAY (instance %d)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span> <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">fx_variable_delay</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_variable_delay</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">else</span> <span class="p">{</span>
        <span class="n">fx_effect</span> <span class="o">*</span> <span class="n">effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">fx_effect</span> <span class="o">*</span><span class="p">)</span> <span class="n">instance_stack</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span><span class="p">;</span>
        <span class="n">effect</span><span class="o">-&gt;</span><span class="n">print_params</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifndef DOXYGEN_SHOULD_SKIP_THIS</span>

<span class="kt">char</span> <span class="o">*</span> <span class="n">fx_pedal</span><span class="o">::</span><span class="n">get_effect_type</span><span class="p">(</span><span class="n">EFFECT_TYPE</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_NONE</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;none&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_AMPLITUDE_MODULATOR</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;amplitude modulator&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_BIQUAD_FILTER</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;biquad filter&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_DESTRUCTOR</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;destructor&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_COMPRESSOR</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;compressor&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_DELAY</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;delay&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_ENVELOPE_TRACKER</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;envelope tracker&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_GAIN</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;gain&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_INSTRUMENT_SYNTH</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;instrument synth&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_MIXER_2</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;mixer x 2&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_MIXER_3</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;mixer x 3&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_MIXER_4</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;mixer x 4&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_RING_MOD</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;ring modulator&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_LOOPER</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;looper&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_OSCILLATOR</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;oscillator&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_PHASE_SHIFTER</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;phase shifter&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_PITCH_SHIFT</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;pitch shift&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_SLICER</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;slicer&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_VARIABLE_DELAY</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;variable delay&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_UNDEFINED</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;undefined&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">FX_CANVAS</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;canvas&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>




















<span class="cm">/************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *                        EFFECTS FUNCTIONS</span>
<span class="cm"> *</span>
<span class="cm"> ***********************************************************************/</span>


<span class="kt">bool</span> <span class="n">fx_effect</span><span class="o">::</span><span class="n">get_audio_node_index</span><span class="p">(</span><span class="n">fx_audio_node</span> <span class="o">*</span> <span class="n">node</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span> <span class="n">local_node_index</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_NODES_PER_FX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="n">audio_node_stack</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
      <span class="o">*</span><span class="n">local_node_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

      <span class="c1">// save in instance</span>
      <span class="n">node_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">fx_effect</span><span class="o">::</span><span class="n">get_control_node_index</span><span class="p">(</span><span class="n">fx_control_node</span> <span class="o">*</span> <span class="n">node</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span> <span class="n">local_node_index</span><span class="p">)</span> <span class="p">{</span>


  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_NODES_PER_FX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="n">control_node_stack</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
      <span class="o">*</span><span class="n">local_node_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

      <span class="c1">// save in instance</span>
      <span class="n">node_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">fx_effect</span><span class="o">::</span><span class="n">serialize_params</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">serialized_params</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="o">*</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>

  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">  sprintf(buf,&quot;Serializing parameters for : %s&quot;, effect_name); Serial.println(buf);</span>
<span class="cp">#endif</span>
  <span class="c1">// serialize instance data</span>
  <span class="kt">int</span> <span class="n">indx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="kt">uint32_t</span> <span class="n">part_32</span><span class="p">;</span>
  <span class="kt">uint16_t</span> <span class="n">part_16</span><span class="p">;</span>
  <span class="kt">uint8_t</span> <span class="n">part_8</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">total_params</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">param_stack_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">T_BOOL</span><span class="p">)</span> <span class="p">{</span>
     <span class="c1">// Serial.println(&quot; : bool&quot;);</span>
      <span class="n">part_16</span> <span class="o">=</span> <span class="o">*</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">param_stack</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="n">serialized_params</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">part_16</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">param_stack_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">T_INT16</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//Serial.println(&quot; : int16&quot;);</span>
      <span class="c1">//Serial.println((int)param_stack[i],HEX);</span>
      <span class="n">serialized_params</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">param_stack</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">param_stack_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">T_INT32</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//Serial.println(&quot; : int32&quot;);</span>
      <span class="n">part_32</span> <span class="o">=</span> <span class="o">*</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">param_stack</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="n">serialized_params</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)((</span><span class="o">*</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">param_stack</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
      <span class="n">serialized_params</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)((</span><span class="o">*</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">param_stack</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">param_stack_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">T_FLOAT</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//Serial.println(&quot; : float&quot;);</span>
      <span class="n">part_32</span> <span class="o">=</span> <span class="o">*</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">param_stack</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="n">serialized_params</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="n">part_32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
      <span class="n">serialized_params</span><span class="p">[</span><span class="n">indx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="p">(</span><span class="n">part_32</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//sprintf(buf,&quot;  %#08x - %d&quot;, param_stack[i], (int) param_stack_types[i]); Serial.println(buf);</span>

  <span class="p">}</span>
  <span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">indx</span><span class="p">;</span>
  <span class="cp">#if 0</span><span class="c"></span>
<span class="c">    Serial.println(&quot;  ------&quot;);</span>

<span class="c">    for (int i=0;i&lt;indx;i++) {</span>
<span class="c">      //sprintf(buf,&quot;  %#04x, [%#08x] -&gt; %#04x - %d&quot;, serialized_params[i], param_stack[i], * (uint16_t *) param_stack[i], (int) param_stack_types[i]); Serial.println(buf);</span>
<span class="c">      sprintf(buf,&quot;  %#04x&quot;, serialized_params[i]); Serial.println(buf);</span>
<span class="c">    }</span>
<span class="c">    Serial.println(&quot;Complete&quot;);</span>
<span class="c">    //sprintf(buf, &quot;Bool: %d&quot; , (int) sizeof(bool)); Serial.println(buf);</span>
<span class="cp">  #endif</span>
<span class="p">}</span>

<span class="kt">bool</span>  <span class="n">fx_effect</span><span class="o">::</span><span class="n">float_param_updated</span><span class="p">(</span> <span class="kt">float</span> <span class="o">*</span> <span class="n">param</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span> <span class="n">param_last</span><span class="p">,</span> <span class="kt">float</span> <span class="n">threshold</span> <span class="p">)</span> <span class="p">{</span>

  <span class="kt">bool</span> <span class="n">different</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="o">*</span><span class="n">param</span> <span class="o">-</span> <span class="o">*</span><span class="n">param_last</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">different</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">different</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="o">*</span><span class="n">param_last</span> <span class="o">=</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">different</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">bool</span>  <span class="n">fx_effect</span><span class="o">::</span><span class="n">bool_param_updated</span><span class="p">(</span> <span class="kt">bool</span> <span class="o">*</span> <span class="n">param</span><span class="p">,</span> <span class="kt">bool</span> <span class="o">*</span> <span class="n">param_last</span> <span class="p">)</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">different</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">param</span> <span class="o">!=</span> <span class="o">*</span><span class="n">param_last</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">different</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="o">*</span><span class="n">param_last</span> <span class="o">=</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">different</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span>  <span class="n">fx_effect</span><span class="o">::</span><span class="n">print_params</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot; No print function declared for this effect&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span>  <span class="n">fx_effect</span><span class="o">::</span><span class="n">service</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot; No service function declared for this effect&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>






<span class="cm">/************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *                        LED FUNCTIONS</span>
<span class="cm"> *</span>
<span class="cm"> ***********************************************************************/</span>


<span class="cp">#ifndef DOXYGEN_SHOULD_SKIP_THIS</span>

<span class="n">fx_led</span><span class="o">::</span><span class="n">fx_led</span><span class="p">(</span><span class="n">LED_POS</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">led_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
  <span class="n">last_scan</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
<span class="p">}</span>


<span class="kt">void</span>  <span class="n">fx_led</span><span class="o">::</span><span class="n">update_rgb_led</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">rgb_write</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">led_pos</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">cur_r</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">cur_g</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">cur_b</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>  <span class="n">fx_led</span><span class="o">::</span><span class="n">service</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">last_scan</span> <span class="o">+</span> <span class="n">LED_UPDATE_RATE_MS</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">last_scan</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">steps</span><span class="p">)</span> <span class="p">{</span>

      <span class="n">cur_r</span> <span class="o">+=</span> <span class="n">inc_r</span><span class="p">;</span>
      <span class="n">cur_g</span> <span class="o">+=</span> <span class="n">inc_g</span><span class="p">;</span>
      <span class="n">cur_b</span> <span class="o">+=</span> <span class="n">inc_b</span><span class="p">;</span>

      <span class="n">update_rgb_led</span><span class="p">();</span>

      <span class="n">steps</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// DOXYGEN_SHOULD_SKIP_THIS</span>



<span class="kt">void</span>  <span class="n">fx_led</span><span class="o">::</span><span class="n">turn_on</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">switch</span><span class="p">(</span><span class="n">led_pos</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">LED_RIGHT</span><span class="p">:</span>
      <span class="n">turn_on_right_footsw_led</span><span class="p">();</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">LED_CENTER</span><span class="p">:</span>
      <span class="n">turn_on_center_footsw_led</span><span class="p">();</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">LED_LEFT</span><span class="p">:</span>
      <span class="n">turn_on_left_footsw_led</span><span class="p">();</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span> <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>  <span class="n">fx_led</span><span class="o">::</span><span class="n">turn_on</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">red</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">green</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">blue</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">set_rgb</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>  <span class="n">fx_led</span><span class="o">::</span><span class="n">turn_on</span><span class="p">(</span><span class="n">LED_COLOR</span> <span class="n">rgb</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">set_rgb</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">rgb</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span>  <span class="n">fx_led</span><span class="o">::</span><span class="n">turn_off</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">switch</span><span class="p">(</span><span class="n">led_pos</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">LED_RIGHT</span><span class="p">:</span> <span class="n">turn_off_right_footsw_led</span><span class="p">();</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">LED_CENTER</span><span class="p">:</span> <span class="n">turn_off_center_footsw_led</span><span class="p">();</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">LED_LEFT</span><span class="p">:</span> <span class="n">turn_off_left_footsw_led</span><span class="p">();</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span> <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>  <span class="n">fx_led</span><span class="o">::</span><span class="n">set_rgb</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">red</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">green</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">blue</span><span class="p">)</span> <span class="p">{</span>
  <span class="cp">#if defined (DM_FX)</span>
    <span class="n">turn_on</span><span class="p">();</span>
  <span class="cp">#elif defined (DM_FX_TWO)</span>
    <span class="n">cur_r</span> <span class="o">=</span> <span class="n">red</span><span class="p">;</span>
    <span class="n">cur_g</span> <span class="o">=</span> <span class="n">green</span><span class="p">;</span>
    <span class="n">cur_b</span> <span class="o">=</span> <span class="n">blue</span><span class="p">;</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">update_rgb_led</span><span class="p">();</span>
  <span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span>  <span class="n">fx_led</span><span class="o">::</span><span class="n">set_rgb</span><span class="p">(</span><span class="n">LED_COLOR</span> <span class="n">rgb</span><span class="p">)</span> <span class="p">{</span>

  <span class="cp">#if defined (DM_FX_TWO)</span>
    <span class="kt">float</span> <span class="n">red</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">rgb</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">green</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">rgb</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">blue</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">rgb</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
    <span class="n">set_rgb</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>
  <span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span>  <span class="n">fx_led</span><span class="o">::</span><span class="n">fade_to_rgb</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">red</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">green</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">milliseconds</span><span class="p">)</span> <span class="p">{</span>
  <span class="cp">#if defined (DM_FX_TWO)</span>
    <span class="n">target_r</span> <span class="o">=</span> <span class="n">red</span><span class="p">;</span>
    <span class="n">target_g</span> <span class="o">=</span> <span class="n">green</span><span class="p">;</span>
    <span class="n">target_b</span> <span class="o">=</span> <span class="n">blue</span><span class="p">;</span>

    <span class="n">steps</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="p">((</span><span class="kt">float</span><span class="p">)</span> <span class="n">milliseconds</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">LED_UPDATE_RATE_MS</span><span class="p">));</span>
    <span class="kt">float</span> <span class="n">inc</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="n">steps</span><span class="p">;</span>

    <span class="n">inc_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_r</span> <span class="o">-</span> <span class="n">cur_r</span><span class="p">)</span> <span class="o">*</span> <span class="n">inc</span><span class="p">;</span>
    <span class="n">inc_g</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_g</span> <span class="o">-</span> <span class="n">cur_g</span><span class="p">)</span> <span class="o">*</span> <span class="n">inc</span><span class="p">;</span>
    <span class="n">inc_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_b</span> <span class="o">-</span> <span class="n">cur_b</span><span class="p">)</span> <span class="o">*</span> <span class="n">inc</span><span class="p">;</span>

    <span class="n">update_rgb_led</span><span class="p">();</span>
  <span class="cp">#endif</span>

<span class="p">}</span>

<span class="kt">void</span>  <span class="n">fx_led</span><span class="o">::</span><span class="n">fade_to_rgb</span><span class="p">(</span><span class="n">LED_COLOR</span> <span class="n">rgb</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">milliseconds</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">float</span> <span class="n">red</span> <span class="o">=</span> <span class="p">(</span><span class="n">rgb</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">green</span> <span class="o">=</span> <span class="p">(</span><span class="n">rgb</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
  <span class="kt">float</span> <span class="n">blue</span> <span class="o">=</span> <span class="n">rgb</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
  <span class="n">fade_to_rgb</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">milliseconds</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Run Jump Labs

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>